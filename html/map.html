<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
        <meta name="application-name" content="SM Overview Map" />
        <meta name="author" content="The1Killer" />
        <meta name="generator" content="https://github.com/the1killer/sm_overview_ahk"/>
        <link rel="icon" href="./assets/img/favicon.png" type="image/png" />
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
        <script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet-src.min.js"></script>
        <script src="libs/leaflet-hash.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
        <script src="assets/js/cellparser.js"></script>
        <style>
            html, body, #map {
                width:100%;
                height:100%;
                margin:0;
                padding:0;
                background-color: #B0B0B0
            }
            .cell {
                font-size: 0.4em;
                word-break: break-all;
            }
            .innercell {
                padding: 0.4em;
            }
            .meadow {
                background-color: #00E85D;
            }
            .lake {
                background-color: #00BAF2;
            }
            .autumnforest {
                background-color: #F2BB07;
            }
            .autumnforest {
                background-color: #F2BB07;
            }
            .forest {
                background-color: #00BC1B;
            }
            .burntforest {
                background-color: #9E8A5C;
            }
            .mountain {
                background-color: #8DBFAC;
            }
            .desert {
                background-color: #FFDE93;
            }
            .field {
                background-color: #A4E07E;
            }
        </style>
    </head>
    <body>
        <div id="map"></div>
        <script>
            var celljson = "";
            var celldata = [];
            var cells = {};

            var minZoom = 0
            var maxZoom = 5
            // create the map
            var map = L.map("map", {
                crs: L.CRS.Simple,
                minZoom: minZoom,
                maxZoom: maxZoom,
            })
            map.attributionControl.addAttribution("<a target='_new' href='https://github.com/the1killer/sm_overview_ahk'>sm_overview_ahk By The1Killer</a>")
            try {
                var hash = new L.Hash(map);
                if(window.location.hash == null || window.location.hash == "") {
                    map.setView([0,0],0);
                    // map.setView([-3563,-3746],0);
                }
            } catch (error) {
                map.setView([0,0],0);
                // map.setView([-3563,-3746],0);
            }
            // L.tileLayer('./img/{x},{y}.jpg', {
            //     noWrap: true,
            //     maxNativeZoom: 1,
            //     minNativeZoom: 1,
            //     tileSize:128,
            //     // tileSize: 1000
            // }).addTo(map)

            let loadFile = async function(file, callback) {
                $.getJSON(file, function() {
                }).done(function(d) {
                    if(typeof callback === 'function') {
                        callback(d);
                    } else {
                        return d;
                    }
                }).fail(function(d, e, f) {
                    console.warn(file + " had a problem loading. Sorry!");
                    console.warn(d, e, f);
                }).always(function() {
                });
            };

            let loadCells = function(json) {
                celljson = json;
                celldata = SMCellParser.parse(json)

                // var cells = {};
                celldata.forEach((cell) => {
                    if(cells[cell.x] == undefined) {
                        cells[cell.x] = {};
                    }
                    cells[cell.x][cell.y] = cell;
                })
                
                L.GridLayer.DebugCoords = L.GridLayer.extend({
                    createTile: function (coords) {
                        var x = coords.x;
                        var y = coords.y;
                        var tile = document.createElement('div');
                        tile.classList.add("cell")
                        var inner = document.createElement('div');
                        inner.classList.add("innercell")
                        inner.innerHTML = [x, y * -1].join(', ');
                        tile.appendChild(inner);
                        // tile.innerHTML = [x, y].join(', ');
                        var div = document.createElement('div');
                        try {
                            var cell = cells[x][y * -1];
                            // var cell = cells[x][y];
                            inner.innerHTML += "<br/><small>"+[cell.xidx, cell.yidx].join(', ')+"</small>";
                            div.innerHTML = cell.type;
                            if(cell.poiType) {
                                div.innerHTML += "<br/><small>"+cell.poiType+"</div>"
                            }
                            tile.classList.add(cell.type.toLowerCase())
                        } catch(error) {
                            // console.log(error)
                        }
                        inner.appendChild(div)
                        tile.style.outline = '1px solid red';
                        return tile;
                    }
                });

                L.gridLayer.debugCoords = function(opts) {
                    return new L.GridLayer.DebugCoords(opts);
                };

                map.addLayer( L.gridLayer.debugCoords({
                    noWrap: true,
                    maxNativeZoom: 1,
                    minNativeZoom: 1,
                    tileSize:50
                }) );
            };

            // loadFile("./assets/json/cells.json",loadCells);
            loadFile("./assets/json/celldata.json",loadCells);

            map.on('click', function(e) {
                // console.log(JSON.stringify(e));
                // console.log(getTileURL(e.latlng.lat, e.latlng.lng, map.getZoom()));
                let xscalar = 5.02;
                let yscalar = 5.83;
                console.log("lnglat:     ", Math.floor(e.latlng.lng),Math.floor(e.latlng.lat));
                console.log("scaled ll:  ", Math.floor(e.latlng.lng * xscalar),Math.floor(e.latlng.lat * yscalar));
                console.log("layer point:", Math.floor(e.layerPoint.x),Math.floor(e.layerPoint.y));
            });

            // .toRad() fix
            // from: http://stackoverflow.com/q/5260423/1418878
            if (typeof(Number.prototype.toRad) === "undefined") {
                Number.prototype.toRad = function() {
                    return this * Math.PI / 180;
                }
            }
            function getTileURL(lat, lon, zoom) {
                var xtile = parseInt(Math.floor( (lon + 180) / 360 * (1<<zoom) ));
                var ytile = parseInt(Math.floor( (1 - Math.log(Math.tan(lat.toRad()) + 1 / Math.cos(lat.toRad())) / Math.PI) / 2 * (1<<zoom) ));
                return "" + zoom + "/" + xtile + "/" + ytile;
            }
    </script>
    </body>
</html>